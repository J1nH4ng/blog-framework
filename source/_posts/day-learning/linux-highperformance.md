---
title: Linux 性能优化
tags:
  - 技术
categories:
  - 代码学习
  - 每日积累
topic: day-learning
id: 1
abbrlink: 123c675b
date: 2024-08-05 00:00:00
---

## 影响 Linux 系统性能的因素

- CPU 负载
- 内存使用
- 磁盘 I/O
- 网络负载
- 进程调度
- 文件系统性能
- 内核参数
- 资源限制和配额

## 故障排除方法

- CPU 性能分析
  - `top`
  - `vmstat`
  - `pidstat`
  - `strace`
  - `perf`
- 内存性能分析
  - `free`
  - `vmstat`
- 磁盘和文件性能 I/O 分析
  - `pidstat`
  - `vmstat`
- 网络性能分析：通过使用率、饱和度以及错误数这几类性能指标

## 排除 OS 中系统负载过高的原因瓶颈

1. 使用`top`和`htop`观察系统整体的负载情况，查看 load average 的值，分别表示系统在 1min 5min 15min 内的平均负载。如果负载超过 CPU 核心数量的 70% - 80%，表示系统负载过高
2. 使用`top`和`htop`命令查看 CPU 占用率。观察哪些进程占用了大量的 CPU 资源，如果又某个进程持续高 CPU 占用，可能是引起负载过高的原因之一
3. 使用`free`命令查看系统内存的使用情况。观察内存的使用量和剩余量。如果内存使用量接近货超过物理内存容量，可能导致系统开始使用交换空间（swap），进而影响系统性能
4. 使用`iotop`命令查看磁盘 I/O 的使用情况。观察磁盘读写速率和占用率。如果磁盘 I/O 负载过高，可能导致系统响应变慢
5. 使用`netstat`命令或类似工具查看网络连接情况。观察是否存在大量的网络连接或网络流量。如果网络连接过多或网络流量过大，可能会影响系统的性能
6. 检查日志文件。查看系统日志文件（/var/log/messages、/var/log/syslog）以及应用程序日志，寻找任何异常或错误信息，可能有助于定位负载过高的问题
7. 使用`perf`或`strace`等工具进行进程级别的性能分析。这些工具可以帮助跟踪进程的系统调用、函数调用和性能瓶颈，进一步确定负载过高的具体原因
8. 检查系统的配置和参数设置。检查相关的配置文件（/etc/sysctl.conf、/etc/security/limits.conf）和参数设置，确保系统的设置与实际需求相匹配，并进行适当的调整

## Linux 找出占用负载 top5 的进程以及主要瓶颈在哪个资源（CPU or 内存 or 磁盘 I/O）

```bash
# CPU 使用排名
ps aux --sort=-%cpu | head -n 5

# 内存使用排名
ps aux --sort=-%mem | head -n 6

# IO 使用排名
iotop -oP

# 查看最占用 CPU 的 10 个进程
ps aux | grep -v USER | sort +2 | tail -n 10

# 查看最占用内存的 10 个进程
ps aux | grep -v USER | sort +3 | tail -n 10

# IO
iostat 1 10
```

## 内存计算不准

free 是执行时间的瞬时计数，/proc/memory 内存是实时变化的

在一些情况下，通过 `ps` 和 `top` 等命令查看的内存使用累计值和 `free` 和 `/proc/meminfo` 文件中的内存统计值之间存在较大差异，可能是由于以下原因导致的

- 缓存和缓冲区：Linux 系统使用缓存和缓冲区来提高文件系统性能。这些缓存和缓冲区占用的内存会被标记为 "cached" （缓存）和 "buffers" （缓冲区）类型。然而，这些内存并不一定是实际被进程使用的内存，而是被内核保留用于提高IO性能。因此， `ps` 或 `top` 命令显示的内存使用累计值可能包括了这些缓存和缓冲区，而 `free` 命令或 `/proc/meminfo` 中的统计值通常不包括它们。

- 共享内存：共享内存是一种特殊的内存区域，多个进程可以访问和共享它。 `ps` 或 `top` 命令显示的内存使用累计值可能会包括共享内存的大小，而 `free` 命令或 `/proc/meminfo` 中的统计值通常不会将其计算在内。

- 内存回收：Linux系统具有内存回收机制，可以在需要时回收未使用的内存。这意味着一些进程释放的内存可能不会立即反映在 `ps` 或 `top` 命令显示的内存使用累计值中。相比之下， `free` 命令或 `/proc/meminfo` 中的统计值通常更及时地反映实际的内存使用情况。

## SWAP 的应用场景

- 内存不足：交换分区作为内存不足时的后备机制，用于将不经常使用或暂时不需要的内存页面转移到磁盘上。当物理内存（RAM）不足以容纳所有活动进程和数据时，交换分区可以提供额外的虚拟内存空间，以避免系统发生内存耗尽错误（Out of Memory）。
- 休眠/睡眠模式：交换分区在某些操作系统中用于支持休眠（hibernation）或睡眠（suspend）模式。当计算机进入休眠或睡眠状态时，系统的内存状态会被保存到交换分区中，以便在唤醒时恢复到先前的状态。
- 虚拟化环境：在虚拟化环境中，交换分区可以用于虚拟机的内存管理。当宿主机的物理内存不足时，虚拟机的内存页面可以被交换到宿主机的交换分区，以提供额外的内存空间。
- 内存回收和页面置换：交换分区可以用于内存回收和页面置换算法。当操作系统需要释放物理内存以满足更紧急的需求时，它可以将不活动的内存页面置换到交换分区中，以便将物理内存分配给更重要的任务或进程

## 性能调优

1. history 命令加入时间和操作者 IP 的属性

    ```shell
    echo "HISTFILESIZE=4000" >> /etc/profile
    echo "HISTSIZE=4000" >> /etc/profile
    echo 'HISTTIMEFORMAT="%F %T `who am i | cut -d "(" -f2 | cut -d ")" -f1` `whoami` "' >> /etc/profile
    echo "export HISTTIMEFORMAT" >> /etc/profile
    ```
